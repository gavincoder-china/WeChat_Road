"use strict";var exports=module.exports={};"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _isIterable2 = require('../../../babel-runtime/core-js/is-iterable.js');

var _isIterable3 = _interopRequireDefault(_isIterable2);

var _getIterator2 = require('../../../babel-runtime/core-js/get-iterator.js');

var _getIterator3 = _interopRequireDefault(_getIterator2);

exports.takeEvery = takeEvery;
exports.takeLatest = takeLatest;
exports.throttle = throttle;

var _channel = require('./channel.js');

var _utils = require('./utils.js');

var _io = require('./io.js');

var _buffers = require('./buffers.js');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var _slicedToArray = function () {
  function sliceIterator(arr, i) {
    var _arr = [];var _n = true;var _d = false;var _e = undefined;try {
      for (var _i = (0, _getIterator3.default)(arr), _s; !(_n = (_s = _i.next()).done); _n = true) {
        _arr.push(_s.value);if (i && _arr.length === i) break;
      }
    } catch (err) {
      _d = true;_e = err;
    } finally {
      try {
        if (!_n && _i["return"]) _i["return"]();
      } finally {
        if (_d) throw _e;
      }
    }return _arr;
  }return function (arr, i) {
    if (Array.isArray(arr)) {
      return arr;
    } else if ((0, _isIterable3.default)(Object(arr))) {
      return sliceIterator(arr, i);
    } else {
      throw new TypeError("Invalid attempt to destructure non-iterable instance");
    }
  };
}();

var done = { done: true, value: undefined };
var qEnd = {};

function fsmIterator(fsm, q0) {
  var name = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 'iterator';

  var updateState = void 0,
      qNext = q0;

  function next(arg, error) {
    if (qNext === qEnd) {
      return done;
    }

    if (error) {
      qNext = qEnd;
      throw error;
    } else {
      updateState && updateState(arg);

      var _fsm$qNext = fsm[qNext](),
          _fsm$qNext2 = _slicedToArray(_fsm$qNext, 3),
          q = _fsm$qNext2[0],
          output = _fsm$qNext2[1],
          _updateState = _fsm$qNext2[2];

      qNext = q;
      updateState = _updateState;
      return qNext === qEnd ? done : output;
    }
  }

  return (0, _utils.makeIterator)(next, function (error) {
    return next(null, error);
  }, name, true);
}

function safeName(pattern) {
  if (Array.isArray(pattern)) {
    return String(pattern.map(function (entry) {
      return String(entry);
    }));
  } else {
    return String(pattern);
  }
}

function takeEvery(pattern, worker) {
  for (var _len = arguments.length, args = Array(_len > 2 ? _len - 2 : 0), _key = 2; _key < _len; _key++) {
    args[_key - 2] = arguments[_key];
  }

  var yTake = { done: false, value: (0, _io.take)(pattern) };
  var yFork = function yFork(ac) {
    return { done: false, value: _io.fork.apply(undefined, [worker].concat(args, [ac])) };
  };

  var action = void 0,
      setAction = function setAction(ac) {
    return action = ac;
  };

  return fsmIterator({
    q1: function q1() {
      return ['q2', yTake, setAction];
    },
    q2: function q2() {
      return action === _channel.END ? [qEnd] : ['q1', yFork(action)];
    }
  }, 'q1', 'takeEvery(' + safeName(pattern) + ', ' + worker.name + ')');
}

function takeLatest(pattern, worker) {
  for (var _len2 = arguments.length, args = Array(_len2 > 2 ? _len2 - 2 : 0), _key2 = 2; _key2 < _len2; _key2++) {
    args[_key2 - 2] = arguments[_key2];
  }

  var yTake = { done: false, value: (0, _io.take)(pattern) };
  var yFork = function yFork(ac) {
    return { done: false, value: _io.fork.apply(undefined, [worker].concat(args, [ac])) };
  };
  var yCancel = function yCancel(task) {
    return { done: false, value: (0, _io.cancel)(task) };
  };

  var task = void 0,
      action = void 0;
  var setTask = function setTask(t) {
    return task = t;
  };
  var setAction = function setAction(ac) {
    return action = ac;
  };

  return fsmIterator({
    q1: function q1() {
      return ['q2', yTake, setAction];
    },
    q2: function q2() {
      return action === _channel.END ? [qEnd] : task ? ['q3', yCancel(task)] : ['q1', yFork(action), setTask];
    },
    q3: function q3() {
      return ['q1', yFork(action), setTask];
    }
  }, 'q1', 'takeLatest(' + safeName(pattern) + ', ' + worker.name + ')');
}

function throttle(delayLength, pattern, worker) {
  for (var _len3 = arguments.length, args = Array(_len3 > 3 ? _len3 - 3 : 0), _key3 = 3; _key3 < _len3; _key3++) {
    args[_key3 - 3] = arguments[_key3];
  }

  var action = void 0,
      channel = void 0;

  var yActionChannel = { done: false, value: (0, _io.actionChannel)(pattern, _buffers.buffers.sliding(1)) };
  var yTake = function yTake() {
    return { done: false, value: (0, _io.take)(channel, pattern) };
  };
  var yFork = function yFork(ac) {
    return { done: false, value: _io.fork.apply(undefined, [worker].concat(args, [ac])) };
  };
  var yDelay = { done: false, value: (0, _io.call)(_utils.delay, delayLength) };

  var setAction = function setAction(ac) {
    return action = ac;
  };
  var setChannel = function setChannel(ch) {
    return channel = ch;
  };

  return fsmIterator({
    q1: function q1() {
      return ['q2', yActionChannel, setChannel];
    },
    q2: function q2() {
      return ['q3', yTake(), setAction];
    },
    q3: function q3() {
      return action === _channel.END ? [qEnd] : ['q4', yFork(action)];
    },
    q4: function q4() {
      return ['q2', yDelay];
    }
  }, 'q1', 'throttle(' + safeName(pattern) + ', ' + worker.name + ')');
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNhZ2FIZWxwZXJzLmpzIl0sIm5hbWVzIjpbInRha2VFdmVyeSIsInRha2VMYXRlc3QiLCJ0aHJvdHRsZSIsIl9zbGljZWRUb0FycmF5Iiwic2xpY2VJdGVyYXRvciIsImFyciIsImkiLCJfYXJyIiwiX24iLCJfZCIsIl9lIiwidW5kZWZpbmVkIiwiX2kiLCJfcyIsIm5leHQiLCJkb25lIiwicHVzaCIsInZhbHVlIiwibGVuZ3RoIiwiZXJyIiwiQXJyYXkiLCJpc0FycmF5IiwiT2JqZWN0IiwiVHlwZUVycm9yIiwicUVuZCIsImZzbUl0ZXJhdG9yIiwiZnNtIiwicTAiLCJuYW1lIiwiYXJndW1lbnRzIiwidXBkYXRlU3RhdGUiLCJxTmV4dCIsImFyZyIsImVycm9yIiwiX2ZzbSRxTmV4dCIsIl9mc20kcU5leHQyIiwicSIsIm91dHB1dCIsIl91cGRhdGVTdGF0ZSIsInNhZmVOYW1lIiwicGF0dGVybiIsIlN0cmluZyIsIm1hcCIsImVudHJ5Iiwid29ya2VyIiwiX2xlbiIsImFyZ3MiLCJfa2V5IiwieVRha2UiLCJ5Rm9yayIsImFjIiwiYXBwbHkiLCJjb25jYXQiLCJhY3Rpb24iLCJzZXRBY3Rpb24iLCJxMSIsInEyIiwiX2xlbjIiLCJfa2V5MiIsInlDYW5jZWwiLCJ0YXNrIiwic2V0VGFzayIsInQiLCJxMyIsImRlbGF5TGVuZ3RoIiwiX2xlbjMiLCJfa2V5MyIsImNoYW5uZWwiLCJ5QWN0aW9uQ2hhbm5lbCIsInNsaWRpbmciLCJ5RGVsYXkiLCJzZXRDaGFubmVsIiwiY2giLCJxNCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7UUFzRGdCQSxTLEdBQUFBLFM7UUF5QkFDLFUsR0FBQUEsVTtRQW1DQUMsUSxHQUFBQSxROztBQWhIaEI7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFMQSxJQUFJQyxpQkFBaUIsWUFBWTtBQUFFLFdBQVNDLGFBQVQsQ0FBdUJDLEdBQXZCLEVBQTRCQyxDQUE1QixFQUErQjtBQUFFLFFBQUlDLE9BQU8sRUFBWCxDQUFlLElB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LEVBQWdCTSxTQUFoQixDQUFQO0FBQ0QsS0FOZ0I7QUFPakJTLFFBQUksU0FBU0EsRUFBVCxHQUFjO0FBQ2hCLGFBQU9WLDBCQUFpQixDQUFDN0IsSUFBRCxDQUFqQixHQUEwQixDQUFDLElBQUQsRUFBT3lCLE1BQU1JLE1BQU4sQ0FBUCxDQUFqQztBQUNELEtBVGdCO0FBVWpCb0IsUUFBSSxTQUFTQSxFQUFULEdBQWM7QUFDaEIsYUFBTyxDQUFDLElBQUQsRUFBT0gsTUFBUCxDQUFQO0FBQ0Q7QUFaZ0IsR0FBWixFQWFKLElBYkksRUFhRSxjQUFjL0IsU0FBU0MsT0FBVCxDQUFkLEdBQWtDLElBQWxDLEdBQXlDSSxPQUFPaEIsSUFBaEQsR0FBdUQsR0FiekQsQ0FBUDtBQWNEIiwiZmlsZSI6InVua25vd24iLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgX3NsaWNlZFRvQXJyYXkgPSBmdW5jdGlvbiAoKSB7IGZ1bmN0aW9uIHNsaWNlSXRlcmF0b3IoYXJyLCBpKSB7IHZhciBfYXJyID0gW107IHZhciBfbiA9IHRydWU7IHZhciBfZCA9IGZhbHNlOyB2YXIgX2UgPSB1bmRlZmluZWQ7IHRyeSB7IGZvciAodmFyIF9pID0gYXJyW1N5bWJvbC5pdGVyYXRvcl0oKSwgX3M7ICEoX24gPSAoX3MgPSBfaS5uZXh0KCkpLmRvbmUpOyBfbiA9IHRydWUpIHsgX2Fyci5wdXNoKF9zLnZhbHVlKTsgaWYgKGkgJiYgX2Fyci5sZW5ndGggPT09IGkpIGJyZWFrOyB9IH0gY2F0Y2ggKGVycikgeyBfZCA9IHRydWU7IF9lID0gZXJyOyB9IGZpbmFsbHkgeyB0cnkgeyBpZiAoIV9uICYmIF9pW1wicmV0dXJuXCJdKSBfaVtcInJldHVyblwiXSgpOyB9IGZpbmFsbHkgeyBpZiAoX2QpIHRocm93IF9lOyB9IH0gcmV0dXJuIF9hcnI7IH0gcmV0dXJuIGZ1bmN0aW9uIChhcnIsIGkpIHsgaWYgKEFycmF5LmlzQXJyYXkoYXJyKSkgeyByZXR1cm4gYXJyOyB9IGVsc2UgaWYgKFN5bWJvbC5pdGVyYXRvciBpbiBPYmplY3QoYXJyKSkgeyByZXR1cm4gc2xpY2VJdGVyYXRvcihhcnIsIGkpOyB9IGVsc2UgeyB0aHJvdyBuZXcgVHlwZUVycm9yKFwiSW52YWxpZCBhdHRlbXB0IHRvIGRlc3RydWN0dXJlIG5vbi1pdGVyYWJsZSBpbnN0YW5jZVwiKTsgfSB9OyB9KCk7XG5cbmltcG9ydCB7IEVORCB9IGZyb20gJy4vY2hhbm5lbCc7XG5pbXBvcnQgeyBtYWtlSXRlcmF0b3IsIGRlbGF5IH0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgeyB0YWtlLCBmb3JrLCBjYW5jZWwsIGFjdGlvbkNoYW5uZWwsIGNhbGwgfSBmcm9tICcuL2lvJztcbmltcG9ydCB7IGJ1ZmZlcnMgfSBmcm9tICcuL2J1ZmZlcnMnO1xuXG52YXIgZG9uZSA9IHsgZG9uZTogdHJ1ZSwgdmFsdWU6IHVuZGVmaW5lZCB9O1xudmFyIHFFbmQgPSB7fTtcblxuZnVuY3Rpb24gZnNtSXRlcmF0b3IoZnNtLCBxMCkge1xuICB2YXIgbmFtZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzJdIDogJ2l0ZXJhdG9yJztcblxuICB2YXIgdXBkYXRlU3RhdGUgPSB2b2lkIDAsXG4gICAgICBxTmV4dCA9IHEwO1xuXG4gIGZ1bmN0aW9uIG5leHQoYXJnLCBlcnJvcikge1xuICAgIGlmIChxTmV4dCA9PT0gcUVuZCkge1xuICAgICAgcmV0dXJuIGRvbmU7XG4gICAgfVxuXG4gICAgaWYgKGVycm9yKSB7XG4gICAgICBxTmV4dCA9IHFFbmQ7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9IGVsc2Uge1xuICAgICAgdXBkYXRlU3RhdGUgJiYgdXBkYXRlU3RhdGUoYXJnKTtcblxuICAgICAgdmFyIF9mc20kcU5leHQgPSBmc21bcU5leHRdKCksXG4gICAgICAgICAgX2ZzbSRxTmV4dDIgPSBfc2xpY2VkVG9BcnJheShfZnNtJHFOZXh0LCAzKSxcbiAgICAgICAgICBxID0gX2ZzbSRxTmV4dDJbMF0sXG4gICAgICAgICAgb3V0cHV0ID0gX2ZzbSRxTmV4dDJbMV0sXG4gICAgICAgICAgX3VwZGF0ZVN0YXRlID0gX2ZzbSRxTmV4dDJbMl07XG5cbiAgICAgIHFOZXh0ID0gcTtcbiAgICAgIHVwZGF0ZVN0YXRlID0gX3VwZGF0ZVN0YXRlO1xuICAgICAgcmV0dXJuIHFOZXh0ID09PSBxRW5kID8gZG9uZSA6IG91dHB1dDtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gbWFrZUl0ZXJhdG9yKG5leHQsIGZ1bmN0aW9uIChlcnJvcikge1xuICAgIHJldHVybiBuZXh0KG51bGwsIGVycm9yKTtcbiAgfSwgbmFtZSwgdHJ1ZSk7XG59XG5cbmZ1bmN0aW9uIHNhZmVOYW1lKHBhdHRlcm4pIHtcbiAgaWYgKEFycmF5LmlzQXJyYXkocGF0dGVybikpIHtcbiAgICByZXR1cm4gU3RyaW5nKHBhdHRlcm4ubWFwKGZ1bmN0aW9uIChlbnRyeSkge1xuICAgICAgcmV0dXJuIFN0cmluZyhlbnRyeSk7XG4gICAgfSkpO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBTdHJpbmcocGF0dGVybik7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRha2VFdmVyeShwYXR0ZXJuLCB3b3JrZXIpIHtcbiAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuID4gMiA/IF9sZW4gLSAyIDogMCksIF9rZXkgPSAyOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7XG4gICAgYXJnc1tfa2V5IC0gMl0gPSBhcmd1bWVudHNbX2tleV07XG4gIH1cblxuICB2YXIgeVRha2UgPSB7IGRvbmU6IGZhbHNlLCB2YWx1ZTogdGFrZShwYXR0ZXJuKSB9O1xuICB2YXIgeUZvcmsgPSBmdW5jdGlvbiB5Rm9yayhhYykge1xuICAgIHJldHVybiB7IGRvbmU6IGZhbHNlLCB2YWx1ZTogZm9yay5hcHBseSh1bmRlZmluZWQsIFt3b3JrZXJdLmNvbmNhdChhcmdzLCBbYWNdKSkgfTtcbiAgfTtcblxuICB2YXIgYWN0aW9uID0gdm9pZCAwLFxuICAgICAgc2V0QWN0aW9uID0gZnVuY3Rpb24gc2V0QWN0aW9uKGFjKSB7XG4gICAgcmV0dXJuIGFjdGlvbiA9IGFjO1xuICB9O1xuXG4gIHJldHVybiBmc21JdGVyYXRvcih7XG4gICAgcTE6IGZ1bmN0aW9uIHExKCkge1xuICAgICAgcmV0dXJuIFsncTInLCB5VGFrZSwgc2V0QWN0aW9uXTtcbiAgICB9LFxuICAgIHEyOiBmdW5jdGlvbiBxMigpIHtcbiAgICAgIHJldHVybiBhY3Rpb24gPT09IEVORCA/IFtxRW5kXSA6IFsncTEnLCB5Rm9yayhhY3Rpb24pXTtcbiAgICB9XG4gIH0sICdxMScsICd0YWtlRXZlcnkoJyArIHNhZmVOYW1lKHBhdHRlcm4pICsgJywgJyArIHdvcmtlci5uYW1lICsgJyknKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRha2VMYXRlc3QocGF0dGVybiwgd29ya2VyKSB7XG4gIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4yID4gMiA/IF9sZW4yIC0gMiA6IDApLCBfa2V5MiA9IDI7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHtcbiAgICBhcmdzW19rZXkyIC0gMl0gPSBhcmd1bWVudHNbX2tleTJdO1xuICB9XG5cbiAgdmFyIHlUYWtlID0geyBkb25lOiBmYWxzZSwgdmFsdWU6IHRha2UocGF0dGVybikgfTtcbiAgdmFyIHlGb3JrID0gZnVuY3Rpb24geUZvcmsoYWMpIHtcbiAgICByZXR1cm4geyBkb25lOiBmYWxzZSwgdmFsdWU6IGZvcmsuYXBwbHkodW5kZWZpbmVkLCBbd29ya2VyXS5jb25jYXQoYXJncywgW2FjXSkpIH07XG4gIH07XG4gIHZhciB5Q2FuY2VsID0gZnVuY3Rpb24geUNhbmNlbCh0YXNrKSB7XG4gICAgcmV0dXJuIHsgZG9uZTogZmFsc2UsIHZhbHVlOiBjYW5jZWwodGFzaykgfTtcbiAgfTtcblxuICB2YXIgdGFzayA9IHZvaWQgMCxcbiAgICAgIGFjdGlvbiA9IHZvaWQgMDtcbiAgdmFyIHNldFRhc2sgPSBmdW5jdGlvbiBzZXRUYXNrKHQpIHtcbiAgICByZXR1cm4gdGFzayA9IHQ7XG4gIH07XG4gIHZhciBzZXRBY3Rpb24gPSBmdW5jdGlvbiBzZXRBY3Rpb24oYWMpIHtcbiAgICByZXR1cm4gYWN0aW9uID0gYWM7XG4gIH07XG5cbiAgcmV0dXJuIGZzbUl0ZXJhdG9yKHtcbiAgICBxMTogZnVuY3Rpb24gcTEoKSB7XG4gICAgICByZXR1cm4gWydxMicsIHlUYWtlLCBzZXRBY3Rpb25dO1xuICAgIH0sXG4gICAgcTI6IGZ1bmN0aW9uIHEyKCkge1xuICAgICAgcmV0dXJuIGFjdGlvbiA9PT0gRU5EID8gW3FFbmRdIDogdGFzayA/IFsncTMnLCB5Q2FuY2VsKHRhc2spXSA6IFsncTEnLCB5Rm9yayhhY3Rpb24pLCBzZXRUYXNrXTtcbiAgICB9LFxuICAgIHEzOiBmdW5jdGlvbiBxMygpIHtcbiAgICAgIHJldHVybiBbJ3ExJywgeUZvcmsoYWN0aW9uKSwgc2V0VGFza107XG4gICAgfVxuICB9LCAncTEnLCAndGFrZUxhdGVzdCgnICsgc2FmZU5hbWUocGF0dGVybikgKyAnLCAnICsgd29ya2VyLm5hbWUgKyAnKScpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdGhyb3R0bGUoZGVsYXlMZW5ndGgsIHBhdHRlcm4sIHdvcmtlcikge1xuICBmb3IgKHZhciBfbGVuMyA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuMyA+IDMgPyBfbGVuMyAtIDMgOiAwKSwgX2tleTMgPSAzOyBfa2V5MyA8IF9sZW4zOyBfa2V5MysrKSB7XG4gICAgYXJnc1tfa2V5MyAtIDNdID0gYXJndW1lbnRzW19rZXkzXTtcbiAgfVxuXG4gIHZhciBhY3Rpb24gPSB2b2lkIDAsXG4gICAgICBjaGFubmVsID0gdm9pZCAwO1xuXG4gIHZhciB5QWN0aW9uQ2hhbm5lbCA9IHsgZG9uZTogZmFsc2UsIHZhbHVlOiBhY3Rpb25DaGFubmVsKHBhdHRlcm4sIGJ1ZmZlcnMuc2xpZGluZygxKSkgfTtcbiAgdmFyIHlUYWtlID0gZnVuY3Rpb24geVRha2UoKSB7XG4gICAgcmV0dXJuIHsgZG9uZTogZmFsc2UsIHZhbHVlOiB0YWtlKGNoYW5uZWwsIHBhdHRlcm4pIH07XG4gIH07XG4gIHZhciB5Rm9yayA9IGZ1bmN0aW9uIHlGb3JrKGFjKSB7XG4gICAgcmV0dXJuIHsgZG9uZTogZmFsc2UsIHZhbHVlOiBmb3JrLmFwcGx5KHVuZGVmaW5lZCwgW3dvcmtlcl0uY29uY2F0KGFyZ3MsIFthY10pKSB9O1xuICB9O1xuICB2YXIgeURlbGF5ID0geyBkb25lOiBmYWxzZSwgdmFsdWU6IGNhbGwoZGVsYXksIGRlbGF5TGVuZ3RoKSB9O1xuXG4gIHZhciBzZXRBY3Rpb24gPSBmdW5jdGlvbiBzZXRBY3Rpb24oYWMpIHtcbiAgICByZXR1cm4gYWN0aW9uID0gYWM7XG4gIH07XG4gIHZhciBzZXRDaGFubmVsID0gZnVuY3Rpb24gc2V0Q2hhbm5lbChjaCkge1xuICAgIHJldHVybiBjaGFubmVsID0gY2g7XG4gIH07XG5cbiAgcmV0dXJuIGZzbUl0ZXJhdG9yKHtcbiAgICBxMTogZnVuY3Rpb24gcTEoKSB7XG4gICAgICByZXR1cm4gWydxMicsIHlBY3Rpb25DaGFubmVsLCBzZXRDaGFubmVsXTtcbiAgICB9LFxuICAgIHEyOiBmdW5jdGlvbiBxMigpIHtcbiAgICAgIHJldHVybiBbJ3EzJywgeVRha2UoKSwgc2V0QWN0aW9uXTtcbiAgICB9LFxuICAgIHEzOiBmdW5jdGlvbiBxMygpIHtcbiAgICAgIHJldHVybiBhY3Rpb24gPT09IEVORCA/IFtxRW5kXSA6IFsncTQnLCB5Rm9yayhhY3Rpb24pXTtcbiAgICB9LFxuICAgIHE0OiBmdW5jdGlvbiBxNCgpIHtcbiAgICAgIHJldHVybiBbJ3EyJywgeURlbGF5XTtcbiAgICB9XG4gIH0sICdxMScsICd0aHJvdHRsZSgnICsgc2FmZU5hbWUocGF0dGVybikgKyAnLCAnICsgd29ya2VyLm5hbWUgKyAnKScpO1xufSJdfQ==